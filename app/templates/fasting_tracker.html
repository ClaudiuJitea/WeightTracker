{% extends "base.html" %}

{% block content %}
<div class="px-4 py-5 sm:px-6">
    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Fasting Tracker</h1>
</div>

<div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
    <!-- Current Fast Status -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex justify-between items-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">Current Fast</h3>
                {% if current_fast %}
                    <form method="POST" action="{{ url_for('fasting.end_fast') }}">
                        <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 dark:focus:ring-offset-gray-800">
                            <i class="fas fa-stop mr-2"></i> End Fast
                        </button>
                    </form>
                {% else %}
                    <button onclick="document.getElementById('startFastModal').classList.remove('hidden')" 
                            class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 dark:focus:ring-offset-gray-800">
                        <i class="fas fa-play mr-2"></i> Start Fast
                    </button>
                {% endif %}
            </div>

            {% if current_fast %}
                <div class="mt-5">
                    <div class="text-center">
                        <div id="fastingTimer" class="text-5xl font-bold text-green-600 dark:text-green-400 mb-2">
                            {{ '%02d:%02d'|format(current_fast.duration_components.hours, current_fast.duration_components.minutes) }}
                        </div>
                        <div id="fastStartTime" 
                             data-start-time="{{ current_fast.start_time.isoformat() }}Z" 
                             data-target-hours="{{ current_fast.target_hours }}"
                             style="display: none;">
                        </div>
                        {% if current_fast.target_hours %}
                            <p class="text-sm text-gray-500 dark:text-gray-400">Target: {{ current_fast.target_hours }} hours</p>
                        {% else %}
                            <p class="text-sm text-gray-500 dark:text-gray-400">Open-ended fast</p>
                        {% endif %}
                    </div>

                    <!-- Progress Bar -->
                    <div class="mt-6">
                        <div class="relative pt-1">
                            <div class="flex mb-2 items-center justify-between">
                                <div>
                                    <span id="fastingProgress" class="text-xs font-semibold inline-block text-green-600 dark:text-green-400">
                                        {% if current_fast.target_hours %}
                                            {{ current_fast.progress|round|int }}% Complete
                                        {% else %}
                                            {{ '%d'|format(current_fast.duration|int) }}h {{ '%d'|format((current_fast.duration % 1) * 60)|int }}m
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs font-semibold inline-block text-green-600 dark:text-green-400">
                                        {% if current_fast.target_hours %}
                                            {{ current_fast.duration|round(1) }} / {{ current_fast.target_hours }} hours
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                            <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-green-200 dark:bg-green-900">
                                {% set progress_value = (current_fast.progress|default(0))|round|int if current_fast.target_hours else 100 %}
                                <div id="progressBar" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-green-500 dark:bg-green-400" {% if progress_value is defined %}style="width: {{ progress_value }}%"{% endif %}></div>
                            </div>
                        </div>
                    </div>

                    <!-- Start and End Times -->
                    <div class="mt-4 grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Started</p>
                            <p class="text-sm text-gray-900 dark:text-white">{{ current_fast.start_time.strftime('%Y-%m-%d %H:%M') }}</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Expected End</p>
                            <p class="text-sm text-gray-900 dark:text-white">
                                {% if current_fast.target_hours %}
                                    {{ (current_fast.start_time + timedelta(hours=current_fast.target_hours)).strftime('%Y-%m-%d %H:%M') }}
                                {% else %}
                                    Not specified
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="mt-5 text-center">
                    <p class="text-gray-500 dark:text-gray-400">No active fast. Start a new fast to track your progress.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Fasting History -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">Fasting History</h3>
            <div class="mt-5 space-y-4">
                {% if fasting_history %}
                    {% for session in fasting_history %}
                        <div class="flex items-center justify-between py-2 border-b border-gray-200 dark:border-gray-700">
                            <div>
                                <p class="text-sm font-medium text-gray-900 dark:text-white">
                                    {% if session.target_hours %}
                                        {{ session.target_hours }} Hour Fast
                                    {% else %}
                                        Open-ended Fast
                                    {% endif %}
                                </p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">
                                    {{ session.start_time.strftime('%Y-%m-%d %H:%M') }} - 
                                    {{ session.end_time.strftime('%Y-%m-%d %H:%M') }}
                                </p>
                            </div>
                            <div class="flex items-center space-x-4">
                                <div class="text-right">
                                    <p class="text-sm font-medium {% if session.target_hours and session.duration >= session.target_hours %}text-green-600 dark:text-green-400{% else %}text-gray-600 dark:text-gray-400{% endif %}">
                                        {{ '%02d:%02d'|format(session.duration|int, ((session.duration % 1) * 60)|int) }}
                                    </p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">
                                        {% if session.target_hours %}
                                            {% if session.duration >= session.target_hours %}
                                                Completed
                                            {% else %}
                                                Ended Early
                                            {% endif %}
                                        {% else %}
                                            Completed
                                        {% endif %}
                                    </p>
                                </div>
                                <form action="{{ url_for('fasting.delete_session', session_id=session.id) }}" method="POST" class="inline">
                                    <button type="submit" class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300" onclick="return confirm('Are you sure you want to delete this fasting session?')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-gray-500 dark:text-gray-400 text-center">No fasting history</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Start Fast Modal -->
<div id="startFastModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white dark:bg-gray-800">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">Start New Fast</h3>
            <div class="mt-2 px-7 py-3">
                <form method="POST" action="{{ url_for('fasting.start_fast') }}" class="space-y-4">
                    <div class="flex items-center justify-between">
                        <label for="is_undefined" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Open-ended fast</label>
                        <input type="checkbox" name="is_undefined" id="is_undefined" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                    </div>
                    <div id="target_hours_container">
                        <label for="target_hours" class="block text-sm font-medium text-gray-700 dark:text-gray-300 text-left">Target Hours</label>
                        <div class="mt-1">
                            <input type="number" name="target_hours" id="target_hours" min="1" max="168" step="0.5" value="16" 
                                   class="shadow-sm focus:ring-primary focus:border-primary block w-full sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md">
                        </div>
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400 text-left">Common fasting protocols: 16:8 (16h), 18:6 (18h), 20:4 (20h), OMAD (23h), 36h, 48h</p>
                    </div>
                    <div class="flex items-center justify-between mt-4">
                        <button type="button" onclick="document.getElementById('startFastModal').classList.add('hidden')" class="py-2 px-4 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500">
                            Cancel
                        </button>
                        <button type="submit" class="py-2 px-4 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">
                            Start Fast
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Include fasting timer script -->
<script src="{{ url_for('static', filename='js/fasting_timer.js') }}"></script>
<script>
    // Update the fasting tracker HTML to ensure compatibility with the fasting.status endpoint for live updates
    setInterval(() => {
        fetch('/fasting/status')
            .then(response => response.json())
            .then(data => {
                if (data.current_fast) {
                    document.getElementById('fastingTimer').innerText = `${padZero(data.current_fast.duration_components.hours)}:${padZero(data.current_fast.duration_components.minutes)}`;
                    document.getElementById('fastStartTime').dataset.startTime = data.current_fast.start_time.isoformat() + 'Z';
                    document.getElementById('fastStartTime').dataset.targetHours = data.current_fast.target_hours;
                    if (data.current_fast.target_hours) {
                        document.getElementById('fastingProgress').innerText = `${data.current_fast.progress}% Complete`;
                        document.getElementById('progressBar').style.width = `${data.current_fast.progress}%`;
                    } else {
                        document.getElementById('fastingProgress').innerText = `${padZero(data.current_fast.duration | 0)}h ${padZero((data.current_fast.duration % 1) * 60 | 0)}m`;
                        document.getElementById('progressBar').style.width = '100%';
                    }
                } else {
                    document.getElementById('fastingTimer').innerText = '00:00';
                    document.getElementById('fastStartTime').dataset.startTime = '';
                    document.getElementById('fastStartTime').dataset.targetHours = '';
                    document.getElementById('fastingProgress').innerText = '';
                    document.getElementById('progressBar').style.width = '0%';
                }
            });
    }, 10000);

    function padZero(num) {
        return (num < 10 ? '0' : '') + num;
    }
</script>
{% endblock %}